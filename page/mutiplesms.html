<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en">
<!--<![endif]-->
<head>
	<meta charset="utf-8">
	<title>Color Admin | Managed Tables</title>
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
	<meta content="" name="description">
	<meta content="" name="author">
	<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
	<script src="https://unpkg.com/vuex@3.0.1/dist/vuex.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<link href="css/css.css" rel="stylesheet">
	<link href="css/jquery-ui.min.css" rel="stylesheet">
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/all.min.css" rel="stylesheet">
	<link href="css/ionicons.min.css" rel="stylesheet">
	<link href="css/animate.min.css" rel="stylesheet">
	<link href="css/style.min.css" rel="stylesheet">
	<link href="css/style-responsive.min.css" rel="stylesheet">
	<link href="css/default.css" rel="stylesheet" id="theme">
	<script src="/js/socketconnect.js"></script>

	<!-- ================== END BASE CSS STYLE ================== -->

	<!-- ================== BEGIN PAGE LEVEL STYLE ================== -->
	<link href="css/dataTables.bootstrap.min.css" rel="stylesheet">
	<link href="css/fixedColumns.bootstrap.min.css" rel="stylesheet">
	<!-- ================== END PAGE LEVEL STYLE ================== -->

	<!-- ================== BEGIN BASE JS ================== -->
	<script src="js/pace.min.js"></script>
</head>
<body>
	<!-- begin #page-loader -->
	<div id="page-loader" class="fade show"><span class="spinner"></span></div>

	<div id="frame">


		<div class="col-12 ui-sortable">
			<!-- begin panel -->
			<div class="panel panel-inverse" data-sortable-id="form-stuff-11">
				<!-- begin panel-heading -->
				<div class="panel-heading ui-sortable-handle" style="background-color: #2c3e50">

				<span class="panel-title" ><a href="/"><i class="fa fa-home"></i> Quay lại</a><span style="float: right;margin-top: -20px;margin-right: 600px;">Lập kế hoạch gửi tin nhắn</span></span>
				</div>

				<div class="panel-body">

					<div class="form-inline">
						<div class="form-group">
							<textarea v-model="message" rows="5" class="form-control" cols="60" type="text"  placeholder="Nội dung tin nhắn"></textarea>

						</div>
						<div class="form-group " style="margin-left:30px;">
							<span style="margin-left:10px">Giờ: </span><input v-model="hour" type="number" class="form-control" style="width: 70px;margin-left:5px" min="0" max="24" placeholder="">
							<span style="margin-left:10px">Phút:</span> <input v-model="minute" type="number"  class="form-control" style="width: 70px;margin-left:5px" min="0" max="60" placeholder="">

							<span style="margin-left:10px">Ngày: </span> <input v-model="date" type="number" class="form-control" style="width: 70px;margin-left:5px" min="1" max="31" placeholder="">
							<span style="margin-left:10px">Tháng: </span> <input v-model="month" type="number" class="form-control" style="width: 70px;margin-left:5px" min="1" max="12" placeholder="">

							<div class="col-md-12" >
							 <input v-model="time" type="number" style="margin-top:10px;width: 250px;margin-left:20px;" type="text" placeholder="Khoảng cách thời gian mỗi lần gửi" class="form-control"> giây
								<br> <br>
								<code v-show="time_blank" style="margin-left: 20px;color:#800a05" class="animated flash ">Bạn phải chọn khoảng cách thời gian gửi tin nhắn.</code>
							</div>

						</div>

						<button v-show="submit" type="submit" @click="alarm" class="btn btn-sm btn-primary m-r-5">Bắt đầu</button>
						<button v-show="cancel" type="submit" @click="cancelAlarm" class="btn btn-sm btn-danger m-r-5">Hủy</button>

					</div>

				</div>

			</div>
			<!-- end panel -->
		</div>

<div class="row">
			<div class="panel panel-inverse col-md-4" style="border:1px solid #e4e7e8">
				<br>
				<code style="margin-left:20px">Xuất hiện {{listAcc.length}} tài khoản</code>
				<button style="float: right" class="btn btn-sm btn-default" @click="GetListFriend">Tìm bạn bè <i class="fa fa-angle-double-right"></i></button>
				<br><br>
				<div class="panel-body">
					<div id="data-table-fixed-columns_wrapper" class="dataTables_wrapper form-inline dt-bootstrap no-footer">
					<table  class="table table-striped table-bordered">
						<thead>
							<tr>
								<th width="1%"></th>
								<th width="1%" data-orderable="false"></th>
								<th class="text-nowrap">Tài khoản</th>
								<th class="text-nowrap"></th>

							</tr>
						</thead>
						<tbody>
						<tr v-for="(data,index) in listAcc" :key="index" >


							<td width="1%" class="f-s-600 text-inverse">{{index+1}}</td>
							<td width="1%" class="with-img"><img :src="data.FacebookImage" class="img-rounded height-30"></td>
							<td><a target="_blank" :href="data.FacebookUrl">{{data.FacebookName}}</a></td>
							<td><input :value="data.ID_sender" v-model="listAccSelect" type="checkbox"></td>

						</tr>

						</tbody>
					</table>
					</div>
				</div>

				<!-- end panel-body -->
			</div>

			<div class="panel panel-inverse col-md-8" >
				<br>
				<code style="margin-left:20px;background-color: #e4e7e8;color:blue">Xuất hiện {{listFriend.length}} bạn bè</code>
				<button style="float: right;margin-right: 20px"  class="btn btn-sm btn-default" @click="selectAll">Chọn tất cả</button>
				Tìm kiếm: <input v-model="search" type="text" style="float: right;width: 150px;margin-right: 20px;height:27px;" class="form-control">

				<br><br>
				<code v-show="receiver_blank" class="animated infinite flash" style="float: right;margin-right: 20px;color:red">Bạn phải chọn ít nhất 1 người dể gửi.</code>
				<div>

							<!-- begin panel -->
							<div class="panel panel-inverse">


								<div class="panel-body">
									<table  class="table table-striped table-bordered">
										<thead>
										<tr>
											<th width="1%">STT</th>
											<th width="1%" data-orderable="false"></th>
											<th class="text-nowrap">User ID</th>
											<th class="text-nowrap">Facebook</th>
											<th class="text-nowrap"></th>

										</tr>
										</thead>
										<tbody>
										<tr v-for="(data,index) in filteredList" :key="index" class="odd gradeX">
											<td width="1%" class="f-s-600 text-inverse">{{index+1}}</td>
											<td width="1%" class="with-img"><img :src="data.profilePicture" class="img-rounded height-30"></td>
											<td>{{data.userID}}</td>
											<td>{{data.fullName}}</td>
											<td><input type="checkbox" :value="data" v-model="listFriendSelect"></td>

										</tr>


										</tbody>
									</table>
								</div>
								<!-- end panel-body -->
							</div>

				</div>


				<!-- end panel-body -->
			</div>
			<!-- end panel -->
</div>

		<!-- end scroll to top btn -->
	</div>

	<!-- end page container -->
	<!-- ================== BEGIN BASE JS ================== -->
	<script src="js/jquery-3.3.1.min.js"></script>
	<script src="js/jquery-ui.min.js"></script>
	<script src="js/bootstrap.bundle.min.js"></script>

	<script src="js/jquery.slimscroll.min.js"></script>
	<script src="js/js.cookie.js"></script>
	<script src="js/apple.min.js"></script>
	<script src="js/apps.min.js"></script>

	<script src="js/jquery.dataTables.js"></script>
	<script src="js/dataTables.bootstrap.min.js"></script>
	<script src="js/dataTables.fixedColumns.min.js"></script>
	<script src="js/table-manage-fixed-columns.demo.min.js"></script>
	<!-- ================== END PAGE LEVEL JS ================== -->

	<script>
        $(document).ready(function() {
            App.init();
            TableManageFixedColumns.init();
        });
	</script>

	<script>

        function setCookie(cname,cvalue,exdays) {
            var d = new Date();
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            var expires = "expires=" + d.toGMTString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }


        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for(var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }



        var app = new Vue({
            el: '#frame',
            head(){
                return {
                    title:store.state.title
                }
            },
            data(){
                return {
                    listAcc:[],
					listAccSelect:[],
					listFriend:[],
					listFriendSelect:[],
                    message:'',
					hour:'',
					minute:'',
					date:'',
					aid:null,
					month:'',
					time:'',
                    username:getCookie("username"),
                    password:getCookie("password"),
                    connect:true,
					submit:true,
					cancel:false,
					search:'',
                    time_blank:false,
                    receiver_blank:false

                }
            },

            created: async  function(){
                let timenow = new Date();
                this.hour = timenow.getHours();
                this.minute = timenow.getMinutes()+1;
                this.date = timenow.getDate();
                this.month = timenow.getMonth()+1;

                let chat = await axios.post('/api/getAllAccount');

                if(chat.data.error === null){

                    this.listAcc = chat.data.data;
                    console.log(this.listAcc)
                }else{
                    window.location.href = "/"
                }
                let alarmDATA = await axios.post('/api/alarmData');

                if(alarmDATA.data.length > 0){
                    this.hour = alarmDATA.data[0].data.hour;
                    this.minute = alarmDATA.data[0].data.minute;
                    this.date = alarmDATA.data[0].data.date;
                    this.month = alarmDATA.data[0].data.month;
                    this.time = alarmDATA.data[0].data.time;
                    this.message = alarmDATA.data[0].data.message;
                    this.aid = alarmDATA.data[0].aid;
                    this.listFriend = alarmDATA.data[0].data.receiver;
                    this.listFriendSelect = alarmDATA.data[0].data.receiver;

                    this.submit = false;
                    this.cancel = true;



                }



            },
            computed: {

                filteredList() {
                    let _ = this;
                    return this.listFriend.filter(e=>{
                        return e.fullName.toLowerCase().includes(_.search.toLowerCase())
					})
                    /*
                    return this.listFriend.filter(post => {
                            return post.fullName.toLowerCase().includes(this.search.toLowerCase())


                    })
                    */
                }
            },
            beforeMount:function(){
                let _ = this;
                socket.on('callback_listFriend',function(result){

                    let listID =  _.listFriend.map(e=>e.userID);
                    result.data = result.data.filter(e=>{
                        if(listID.includes(e.userID) === false){
                            return e
                        }
                    });
                    return _.listFriend = _.listFriend.concat(result.data)
                });


            },
            mounted:function(){

                let name = this.username;
                let _ = this;

                $("form").change(function(evt){
                    evt.preventDefault();
                    var formData = new FormData($(this)[0]);
                    $.ajax({
                        url: '/api/uploadIMAGE',
                        type: 'POST',
                        data: formData,
                        async: false,
                        cache: false,
                        contentType: false,
                        enctype: 'multipart/form-data',
                        processData: false,
                        success: function (response) {

                            socket.emit('sendMessage',{
                                userBoss:name,
                                ID_receiver:store.state.conversation.ID_receiver,
                                type:'attachments',
                                url:response,
                                ID_sender:store.state.conversation.ID_sender
                            },function(callback){

                                return store.commit('pushConversation',callback.data)

                            });
                        }
                    });
                    return false;
                });
            },
            methods:{
                GetListFriend:function(){
                    this.receiver_blank = false;
                    let _ = this;
                    socket.emit('GetListFriend',{
                        list: _.listAccSelect
					})
				},
				sendMessFriend:async function(){
                    console.log(this.listFriendSelect)
				},
				selectAll:async function(){
                    if(this.listFriendSelect.length >0){
                        return this.listFriendSelect = [];

                    }else{
                        return this.listFriendSelect = this.listFriend

                    }
				},
				alarm:async function(){
                    if(this.time === ''){
                        this.time_blank = true;
                        return false;
					}
					if (this.listFriendSelect.length === 0){
					    this.receiver_blank = true;
					    return false;
					}


                        let setAlarm = await axios.post('/api/hen-gio',{data:{aid:this.aid,hour:this.hour,minute:this.minute,date:this.date,month:this.month,time:this.time,message:this.message,receiver:this.listFriendSelect}});
                        this.aid =setAlarm.data;
						socket.emit('sendMessFriend',{aid:setAlarm.data,hour:this.hour,minute:this.minute,date:this.date,month:this.month,time:this.time,message:this.message,receiver:this.listFriendSelect})
                        this.cancel = true;
                        this.submit = false;

				},
				cancelAlarm:async function(){

                     await axios.post('/api/xoa-hen-gio',{aid:this.aid});
                     this.cancel = false;
                     this.submit = true;

				}


            },
        })

	</script>
</body>
</html>
